<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" data-mc-search-type="Stem" data-mc-help-system-file-name="index.xml" data-mc-path-to-help-system="../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-medium="non-print" data-mc-toc-path="Data Processing Reference|Preliminary Processing">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>EddyPro 5 Help | Time Lag Detection and Correction</title>
        <script>/* <![CDATA[ */
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-22299342-5', 'licor.com');
			ga('send', 'pageview');

		/* ]]> */</script>
        <link href="Resources/Fonts/OpenSans-Regular-webfont.eot" rel="font" />
        <link href="Resources/Fonts/OpenSans-Regular-webfont.svg" rel="font" />
        <link href="Resources/Fonts/OpenSans-Regular-webfont.ttf" rel="font" />
        <link href="Resources/Fonts/OpenSans-Bold-webfont.woff" rel="font" />
        <link href="Resources/Fonts/OpenSans-Bold-webfont.eot" rel="font" />
        <link href="Resources/Fonts/OpenSans-Bold-webfont.svg" rel="font" />
        <link href="Resources/Fonts/OpenSans-Bold-webfont.ttf" rel="font" />
        <link href="Resources/Fonts/OpenSans-Bold-webfont.woff" rel="font" />
        <link href="../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="Resources/Stylesheets/HelpEnv.css" rel="stylesheet" />
        <script src="../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../Resources/Scripts/foundation.min.js">
        </script>
        <script src="../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../Resources/Scripts/require.min.js">
        </script>
        <script src="../Resources/Scripts/require.config.js">
        </script>
        <script src="../Resources/Scripts/MadCapAll.js">
        </script>
    </head>
    <body>
        <p class="MCWebHelpFramesetLink MCWebHelpFramesetLinkTop"><a href="../index.htm#Time_Lag_Detect_Correct.htm">Open topic with navigation</a>
        </p>
        <div class="wrapper">
            <div class="MCBreadcrumbsBox_0"><span class="MCBreadcrumbsPrefix">EddyPro 5 Help &gt; </span><span class="MCBreadcrumbsSelf">Data Processing Reference</span><span class="MCBreadcrumbsDivider"> &gt; </span><span class="MCBreadcrumbsSelf">Preliminary Processing</span><span class="MCBreadcrumbsDivider"> &gt; </span><span class="MCBreadcrumbs">Detecting and Compensating for Time Lags</span>
            </div>
            <div class="resources">
                <p style="color:#0072B2; font-size:19px; font-style: italic; font-weight: 600; line-height: 22px; margin-bottom: 15 px; text-shadow: 0 1 px 1 px #ffffff;">Resources:</p>
                <ul style="margin-left: -15px;">
                    <li value="1"><a href="Video_Library.htm">Video Tutorials</a>
                    </li>
                    <li value="2"><a href="https://licor.box.com/s/qmhucid6g0hdvd3d13tk" target="_blank">Overview of EddyPro Work-flows</a>
                    </li>
                    <li value="3"><a href="https://licor.box.com/s/1ium2zmwm6hl36yz9bu4" target="_blank">Printable PDF Manual</a>
                    </li>
                    <li value="4"><a href="http://www.licor.com/env/forum/forum.php?id=8" target="_parent"><span class="MyVariablesSoftwareName">EddyPro</span> Forum</a>
                    </li>
                </ul>
            </div>
            <h1>Detecting and Compensating for Time Lags</h1>
            <p class="note">See <a href="Selecting_Advanced_Options.htm" class="TOCPageNumber MCXref xref xrefTOCPageNumber">Selecting Advanced Processing Options</a> for more information.</p>
            <p><a name="Time"></a><a name="kanchor198"></a>The last step of raw data processing in <span class="MyVariablesSoftwareName R">EddyPro®</span>, prior to flux calculation and correction, regards the compensation of possible time lags between anemometric variables and variables measured by any other sensor, notably the gas analyzer(s). A time lag arises for different reasons in closed path and in open path systems.</p>
            <p>The presence of the intake tube in closed path systems (with the inlet normally placed very close to the anemometer measuring volume) implies that gas concentrations are measured always with a certain delay with respect to the moment air is sampled. In addition, the residence time of sticky gases, such as H<sub>2</sub>O, in the sampling line is a strong function of air relative humidity and temperature. Conversely, sonic anemometers measure wind speed and sonic temperature without detectable delays. In open path systems the delay is due to the physical distance between the two instruments (gas analyzer and anemometer), which are usually placed several decimeters or less apart to avoid mutual disturbances. The wind field takes some time to travel from one to the other, resulting in a certain delay between the moments the same air parcel is sampled by the two instruments.</p>
            <p>It is a common practice to compensate for time lags before calculating covariances between anemometric variables and gas analyzer measurements. <span class="MyVariablesSoftwareName">EddyPro</span> provides four different methods for detecting and compensating time lags, besides the option of not compensating at all, which speeds up program execution but will almost certainly lead to systematic flux underestimations.</p>
            <h2>Constant</h2>
            <p>In the Raw File Description table, you can enter <b style="font-style: italic;">Nominal time lags</b> for variables not measured by the master anemometer. In closed path systems, a nominal time lag can be estimated from the volume of the intake tube and the average flow rate in the tube. In open path systems, a nominal lag can be computed by considering the transit time in the space between the instruments, with site-specific typical wind speeds and directions. Selecting <i>Constant</i> will instruct <span class="MyVariablesSoftwareName">EddyPro</span> to use such nominal values as fixed time lags. Using this option makes the program execution faster, because the automatic time lag detection procedure is avoided. However, this option is only suitable for closed path systems featuring an active control of the sampling line flow rate, such that the travel time of air in the tube does not change as a result of pump fluctuations, filter clogging, or any other reason. Also, this option is not recommended when measuring “sticky” gases such as H<sub>2</sub>O, whose residence time varies according to climatic (RH, T) conditions, on account of sorption processes occurring at the tube walls (e.g., <a href="References.htm#Runkle">Runkle et al., 2012</a>).</p>
            <p class="note"><b>Note:</b> If you leave the Nominal time lag set to <i>zero</i>, <span class="MyVariablesSoftwareName">EddyPro</span> will <a href="Nominal_Time_Lag.htm">automatically calculate</a> the most plausible value for you.</p>
            <h2>Covariance Maximization</h2>
            <p>A certain degree of uncertainty in the control over the flow rate (closed path) and the variability of wind regimes (open path) suggests an automatic time lag detection procedure, normally performed for each flux averaging period. Typically the detection is accomplished via the “covariance maximization” procedure, consisting in the determination the time lag that maximizes the covariance of two variables, within a window of plausible time lags (e.g., <a href="References.htm#Fan">Fan et al., 1990</a>):</p>
            <p>
                <img src="GeneratedImages/Equations/Equation54.png" style="width: 280px;height: 55px;" alt="" class="MCEquation_0 mcReset" />
            </p>
            <p>In this equation, N is the total number of samples in the current flux averaging interval; m and M are the discrete counterparts of the minimum and maximum plausible time lags, respectively; τ is the best time lag estimate, and jz is its discrete counterpart. You can toggle between discrete indices and actual times in seconds by dividing the formers by the acquisition frequency (<i>f</i><sub style="font-style: italic;">a</sub>, Hz), e.g., <i>τ = j</i><sub style="font-style: italic;">τ</sub><i> • f</i><sub style="font-style: italic;">a</sub><sup>-1</sup>.</p>
            <p>The minimum and maximum plausible time lags are either taken from the <b style="font-style: italic;">Minimum time lag</b> and <b style="font-style: italic;">Maximum time lag</b> entered in the <b>Raw File Description</b> table or, if those are left at zero, <a href="Nominal_Time_Lag.htm">automatically calculated</a> by EddyPro.</p>
            <h2>Covariance maximization with default</h2>
            <p>Selecting this option, if - during the covariance maximization procedure depicted above - a maximum is not attained within the plausibility window, a default is used, either taken as the <b style="font-style: italic;">Nominal time lag</b> in the <b style="font-style: italic;">Raw File Description</b> table or automatically calculated by EddyPro.</p>
            <p>Using the covariance maximization procedure (either with or without default), a plausible time lag window has to be defined with the <b style="font-style: italic;">Minimum</b> and <b style="font-style: italic;">Maximum time lags</b>, which constitute the end points of the plausibility window. A too narrowed plausible window might lead to frequent use of the default (<b style="font-style: italic; font-weight: normal;">Covariance maximization with default</b>) or either endpoint (<i>Covariance maximization</i>) time lag, because the actual time lag is often found outside defined plausibility range. This situation leads to systematic flux underestimations. Conversely, imposing a too broad plausibility window increases the possibility that unrealistic time lags are detected, especially when covariances are small and vary erratically with the lag time. These cases often result in flux overestimations. A trade-off must be reached between the two contrasting needs.</p>
            <h2>Automatic time lag optimization</h2>
            <p><span class="MyVariablesSoftwareName">EddyPro</span> also provides the possibility of analyzing the actual time lags found in the available dataset and determining the most suitable <b style="font-style: italic;">Nominal time lag</b> and plausibility window (Minimum and Maximum time lags). This procedure implies a pre-processing step, before actually processing raw files, to statistically evaluate the most likely time lags and their ranges of variations. In this step, raw files are actually handled in a very similar manner as done later in the raw data processing step (e.g., despiking, angle-of-attack correction, detrending, etc.), but the processing stops at the calculation of the time lag. Here, the <i>Covariance Maximization</i> procedure is applied, adopting very broad (and user-customizable) time lag windows. Then, optimal time lags are calculated, in different ways for passive gases (e.g., CO<sub>2</sub>, CH<sub>4</sub>) and for H<sub>2</sub>O.</p>
            <h3>Time lag optimization for passive gases</h3>
            <p>For passive gases, whose time lag is not expected to depend on climatic conditions or other drivers, the nominal time lag is calculated as the median of all calculated time lags:</p>
            <p>
                <img src="GeneratedImages/Equations/Equation55.png" style="width: 129px;height: 18px;" alt="" class="MCEquation_0 mcReset" />
            </p>
            <p>where, for convenience, τ<sub>i</sub> represents all time lags calculated from the available dataset.</p>
            <p>The plausibility window is defined as:</p>
            <p>
                <img src="GeneratedImages/Equations/Equation56.png" style="width: 302px;height: 26px;" alt="" class="MCEquation_0 mcReset" />
            </p>
            <p>
                <img src="GeneratedImages/Equations/Equation57.png" style="width: 301px;height: 26px;" alt="" class="MCEquation_0 mcReset" />
            </p>
            <p>where <i>z</i> is a user-selectable parameter, that's optimal value was heuristically determined to be around 1.5.</p>
            <p class="note"><b>Note:</b> This assessment must be performed on a dataset long enough for calculating robust statistics. At least 1 month of data is recommended. </p>
            <p class="note"><b>Note:</b> The dataset used to optimize time lags must refer to a period, in which the sampling line did not undergo major modifications, such as replacement of tube or filters, change of the flow rate, etc. In the whole period, time lags are expected to be stationary.</p>
            <h3>Time lag optimization for water vapor</h3>
            <p>The time lag of water vapor is a strong function of relative humidity (and secondarily, a function of temperature). Thus, for water vapor, nominal time lags and plausibility windows are assessed for relative humidity classes in the range 0 to 100%. In each class, the same definitions used for passive gases are also used:</p>
            <p>
                <img src="GeneratedImages/Equations/Equation58.png" style="width: 199px;height: 19px;" alt="" class="MCEquation_0 mcReset" />
            </p>
            <p>
                <img src="GeneratedImages/Equations/Equation59.png" style="width: 440px;height: 27px;" alt="" class="MCEquation_0 mcReset" />
            </p>
            <p>
                <img src="GeneratedImages/Equations/Equation60.png" style="width: 439px;height: 27px;" alt="" class="MCEquation_0 mcReset" />
            </p>
            <p>where now the subscript class indicates that a different value is calculated for each class. Also here <i>z</i> is a user-selectable parameter, with an optimal value is around 1.5.</p>
            <p>For each class, a minimum of 30 time lags need be present, for the statistics to be considered valid. Depending on the length of the dataset, such numerosity may not be reached for all class. In such cases, <span class="MyVariablesSoftwareName">EddyPro</span> behaves as follows:</p>
            <ul class="bulleted">
                <li value="1">If the first <i>n</i> classes do not have enough numerosity, their time lags (nominal, minimum, and maximum) are set equal to those of class (<i>n</i> + 1);</li>
                <li value="2">If the last <i>n</i> classes do not have enough numerosity, their time lags are set to a linear extrapolation of classes (<i>n</i><sub style="font-style: italic;">t</sub> – <i>n</i>) and (<i>n</i><sub style="font-style: italic;">t</sub><i> <![CDATA[ ]]></i>- <i>n</i> - 1), where <i>n<sub>t</sub></i> represent the total number of classes;</li>
                <li value="3">If any intermediate class <i>i</i> does not have enough numerosity, its time lags are set to the average of classes <i>i</i> – 1 and (<i>i</i> + 1).</li>
            </ul>
            <p class="note"><b>Note:</b> Due to the class sorting, a much longer dataset is needed for water vapor. A minimum 2 months of raw data are deemed necessary, possibly spanning a broad range of climatic conditions. A longer dataset (&gt; 6 month) will allow a more robust optimization. </p>
            <p>The figure below shows the results of a time lag optimization procedure using 6 months of data. Yellow circles are actual time lags calculated using a very large time lag window while blue lines are nominal, minimum, and maximum time lags calculated by <span class="MyVariablesSoftwareName">EddyPro</span> as a function of RH, by means of the time lag optimization procedure.</p>
            <p><a class="MCPopupThumbnailLink MCPopupThumbnailPopup" href="Resources/Images/Time_lags_RH.png"><img class="MCPopupThumbnail img imgwidth300pt" data-mc-width="798" data-mc-height="599" src="Resources/Images/Time_lags_RH_thumb_0_96.png" tabindex="" /></a>
            </p>
            <p class="note"><b>Note:</b> During the following phase of raw data processing, the actual nominal, minimum, and maximum time lags are determined as a function of the current value of relative humidity.</p>
            <div class="push">
            </div>
        </div>
        <div class="foot">
            <div style="float:left;">
                <p class="footer">Product Information:</p>
                <ul class="footer" style="padding-left: 10px;padding-top: 3px;">
                    <li class="nb" style="font-size: 0.8em;" value="1">EddyPro 5 Eddy Covariance Software</li>
                    <li class="nb" style="font-size: 0.8em;" value="2">Help updated on: <span class="SystemShortDate">11/7/2014</span></li>
                </ul>
                <p class="footer">© 2011 - 2014 LI-COR, Inc.</p>
            </div>
            <div style="float:right;">
                <p class="footer">Contact Us:</p>
                <ul class="footer" style="padding-left: 10px;padding-top: 3px;">
                    <li class="nb" value="1"><a class="footer" href="mailto:envsupport@licor.com" title="Email LI-COR support" alt="Email LI-COR support" style="font-size: 0.8em; text-decoration: none;">envsupport@licor.com</a>
                    </li>
                    <li class="nb" value="2"><a class="footer" href="http://www.licor.com/env" title="Go to the LI-COR website" target="_blank" alt="Go to the LI-COR website" style="text-decoration: none; font-size: 0.8em;">www.licor.com/env</a>
                    </li>
                    <li class="nb" style="font-size: 0.8em;" value="3">International: 1-402-467-3576</li>
                    <li class="nb" style="font-size: 0.8em;" value="4">US: 800-447-3576</li>
                </ul>
            </div>
        </div>
    </body>
</html>